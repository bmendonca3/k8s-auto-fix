apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-gitlab-runner
  namespace: default
  labels:
    app: release-name-gitlab-runner
    chart: gitlab-runner-0.81.0
    release: release-name
    heritage: Helm
data:
  entrypoint: "#!/bin/bash\nset -e\n\nexport CONFIG_PATH_FOR_INIT=\"/home/gitlab-runner/.gitlab-runner/\"\
    \nmkdir -p ${CONFIG_PATH_FOR_INIT}\ncp /configmaps/config.toml ${CONFIG_PATH_FOR_INIT}\n\
    \n# Set up environment variables for cache\nif [[ -f /secrets/accesskey && -f\
    \ /secrets/secretkey ]]; then\n  export CACHE_S3_ACCESS_KEY=$(cat /secrets/accesskey)\n\
    \  export CACHE_S3_SECRET_KEY=$(cat /secrets/secretkey)\nfi\n\nif [[ -f /secrets/gcs-applicaton-credentials-file\
    \ ]]; then\n  export GOOGLE_APPLICATION_CREDENTIALS=\"/secrets/gcs-applicaton-credentials-file\"\
    \nelif [[ -f /secrets/gcs-application-credentials-file ]]; then\n  export GOOGLE_APPLICATION_CREDENTIALS=\"\
    /secrets/gcs-application-credentials-file\"\nelse\n  if [[ -f /secrets/gcs-access-id\
    \ && -f /secrets/gcs-private-key ]]; then\n    export CACHE_GCS_ACCESS_ID=$(cat\
    \ /secrets/gcs-access-id)\n    # echo -e used to make private key multiline (in\
    \ google json auth key private key is oneline with \\n)\n    export CACHE_GCS_PRIVATE_KEY=$(echo\
    \ -e $(cat /secrets/gcs-private-key))\n  fi\nfi\n\nif [[ -f /secrets/azure-account-name\
    \ && -f /secrets/azure-account-key ]]; then\n  export CACHE_AZURE_ACCOUNT_NAME=$(cat\
    \ /secrets/azure-account-name)\n  export CACHE_AZURE_ACCOUNT_KEY=$(cat /secrets/azure-account-key)\n\
    fi\n\nif [[ -f /secrets/runner-registration-token ]]; then\n  export REGISTRATION_TOKEN=$(cat\
    \ /secrets/runner-registration-token)\nfi\n\nif [[ -f /secrets/runner-token ]];\
    \ then\n  export CI_SERVER_TOKEN=$(cat /secrets/runner-token)\nfi\n\n# Register\
    \ the runner\nif ! sh /configmaps/register-the-runner; then\n  exit 1\nfi\n\n\
    # Run pre-entrypoint-script\nif ! bash /configmaps/pre-entrypoint-script; then\n\
    \  exit 1\nfi\n\n# Start the runner\nexec /entrypoint run \\\n  --working-directory=/home/gitlab-runner\n"
  config.toml: 'shutdown_timeout = 0

    concurrent = 10

    check_interval = 3

    log_level = "info"

    '
  config.template.toml: "[[runners]]\n  [runners.kubernetes]\n    namespace = \"default\"\
    \n    image = \"alpine\"\n"
  register-the-runner: "#!/bin/sh\nsignal_handler() {\n  if [ ! -d \"/proc/$register_pid\"\
    \ ]; then\n    wait $register_pid\n  fi\n  exit\n}\ntrap 'signal_handler' QUIT\
    \ INT\n\nMAX_REGISTER_ATTEMPTS=30\n\n# Reset/unset the not needed flags when an\
    \ authentication token\nRUN_UNTAGGED=\"\"\nACCESS_LEVEL=\"\"\n\nif [ -n \"$CI_SERVER_TOKEN\"\
    \ ] && [ \"${CI_SERVER_TOKEN#glrt-}\" != \"$CI_SERVER_TOKEN\" ]; then\n  RUN_UNTAGGED=\"\
    \"\n  ACCESS_LEVEL=\"\"\n  unset REGISTER_LOCKED\n  unset RUNNER_TAG_LIST\nfi\n\
    \nfor i in $(seq 1 \"${MAX_REGISTER_ATTEMPTS}\"); do\n  echo \"Registration attempt\
    \ ${i} of ${MAX_REGISTER_ATTEMPTS}\"\n  /entrypoint register \\\n    ${RUN_UNTAGGED}\
    \ \\\n    ${ACCESS_LEVEL} \\\n    --template-config /configmaps/config.template.toml\
    \ \\\n    --non-interactive &\n\n  register_pid=$!\n  wait $register_pid\n  retval=$?\n\
    \n  if [ ${retval} = 0 ]; then\n    break\n  elif [ ${i} = ${MAX_REGISTER_ATTEMPTS}\
    \ ]; then\n    exit 1\n  fi\n\n  sleep 5\ndone\n"
  check-live: "#!/bin/bash\nset -eou pipefail\n\n# default timeout is 3 seconds, can\
    \ be overriden\nVERIFY_TIMEOUT=${1:-${VERIFY_TIMEOUT:-3}}\n\nif ! /usr/bin/pgrep\
    \ -f \".*register-the-runner\"  > /dev/null && ! /usr/bin/pgrep -f \"gitlab.*runner\"\
    \  > /dev/null ; then\n  exit 1\nfi\n\nstatus=0\n# empty --url= helps `gitlab-runner\
    \ verify` select all configured runners (otherwise filters for $CI_SERVER_URL)\n\
    verify_output=$(timeout \"${VERIFY_TIMEOUT}\" gitlab-runner verify --url= 2>&1)\
    \ || status=$?\n\n# timeout exit code is 143 with busybox, and 124 with coreutils\n\
    if (( status == 143 )) || (( status == 124 )) ; then\n  echo \"'gitlab-runner\
    \ verify' terminated by timeout, not a conclusive failure\" >&2\n  exit 0\nelif\
    \ (( status > 0 )) ; then\n  exit ${status}\nfi\n\ngrep -qE \"is (alive|valid)\"\
    \ <<<\"${verify_output}\"\n"
  pre-entrypoint-script: ''
