apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: tf-nightly-maskrcnn-func-v3-8
  namespace: automated
spec:
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600
      backoffLimit: 1
      template:
        metadata:
          annotations:
            tf-version.cloud-tpus.google.com: nightly
        spec:
          containers:
          - env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            image: gcr.io/xl-ml-test/health-monitor:stable
            imagePullPolicy: Always
            name: monitor
          - args:
            - python3
            - official/vision/detection/main.py
            - --model=mask_rcnn
            - "--params_override=\"architecture\":\n  \"use_bfloat16\": true\n\"eval\"\
              :\n  \"batch_size\": 40\n  \"eval_file_pattern\": \"$(COCO_DIR)/val*\"\
              \n  \"val_json_file\": \"$(COCO_DIR)/instances_val2017.json\"\n\"postprocess\"\
              :\n  \"pre_nms_num_boxes\": 1000\n\"predict\":\n  \"batch_size\": 40\n\
              \"train\":\n  \"batch_size\": 64\n  \"checkpoint\":\n    \"path\": \"\
              $(RESNET_PRETRAIN_DIR)/resnet50-checkpoint-2018-02-07\"\n    \"prefix\"\
              : \"resnet50/\"\n  \"iterations_per_loop\": 5000\n  \"total_steps\"\
              : 1000\n  \"train_file_pattern\": \"$(COCO_DIR)/train*\"\n"
            - --model_dir=$(MODEL_DIR)
            - --mode=train
            - --strategy_type=tpu
            - --tpu=$(KUBE_GOOGLE_CLOUD_TPU_ENDPOINTS)
            env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: MODEL_DIR
              value: $(OUTPUT_BUCKET)/tf-nightly/maskrcnn/func/v3-8/$(JOB_NAME)
            envFrom:
            - configMapRef:
                name: gcs-buckets
            image: gcr.io/xl-ml-test/tensorflow:nightly
            imagePullPolicy: Always
            name: train
            resources:
              limits:
                cloud-tpus.google.com/preemptible-v3: 8
              requests:
                cpu: 2
                memory: 20G
            volumeMounts:
            - mountPath: /dev/shm
              name: dshm
              readOnly: false
          initContainers:
          - env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: MODEL_DIR
              value: $(OUTPUT_BUCKET)/tf-nightly/maskrcnn/func/v3-8/$(JOB_NAME)
            - name: METRIC_CONFIG
              value: "{\n \"metric_collection_config\": {\n  \"default_aggregation_strategies\"\
                : [\n   \"final\"\n  ],\n  \"metric_to_aggregation_strategies\": {\n\
                \   \"examples_per_second\": [\n    \"average\"\n   ]\n  },\n  \"\
                use_run_name_prefix\": true,\n  \"write_to_bigquery\": true\n },\n\
                \ \"regression_test_config\": {\n  \"metric_success_conditions\":\
                \ {\n   \"examples_per_second_average\": {\n    \"comparison\": \"\
                greater_or_equal\",\n    \"success_threshold\": {\n     \"stddevs_from_mean\"\
                : 4\n    }\n   },\n   \"total_wall_time\": {\n    \"comparison\":\
                \ \"less\",\n    \"success_threshold\": {\n     \"stddevs_from_mean\"\
                : 5\n    },\n    \"wait_for_n_points_of_history\": 10\n   }\n  }\n\
                \ },\n \"test_name\": \"tf-nightly-maskrcnn-func-v3-8\"\n}\n"
            envFrom:
            - configMapRef:
                name: gcs-buckets
            image: gcr.io/xl-ml-test/publisher:stable
            imagePullPolicy: Always
            name: publisher
          nodeSelector:
            tpu-available: 'true'
          restartPolicy: Never
          volumes:
          - emptyDir:
              medium: Memory
            name: dshm
  schedule: 0 8 * * *
  successfulJobsHistoryLimit: 1
  suspend: true
