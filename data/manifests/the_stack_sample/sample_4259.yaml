apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: tf-nightly-keras-api-transfer-learning-v2-8
  namespace: automated
spec:
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600
      backoffLimit: 2
      template:
        metadata:
          annotations:
            tf-version.cloud-tpus.google.com: nightly
        spec:
          containers:
          - args:
            - /bin/bash
            - -c
            - 'set -u

              set -e

              set -x


              export PATH=$PATH:/root/google-cloud-sdk/bin

              gcloud source repos clone cloudtpu-tf20-api-tests --project=gcp-tpupods-demo

              cd cloudtpu-tf20-api-tests

              pip3 install behave

              behave -e ipynb_checkpoints --tags=-fails -i transfer_learning

              '
            - --model_dir=$(MODEL_DIR)
            env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: METRIC_CONFIG
              value: "{\n \"metric_collection_config\": {\n  \"default_aggregation_strategies\"\
                : [\n   \"final\"\n  ],\n  \"write_to_bigquery\": true\n },\n \"regression_test_config\"\
                : {\n  \"alert_for_failed_jobs\": false\n },\n \"test_name\": \"tf-nightly-keras-api-transfer-learning-v2-8\"\
                \n}\n"
            - name: MODEL_DIR
              value: gs://xl-ml-test-us-central1/k8s/keras-api/transfer-learning/v2-8/$(JOB_NAME)
            image: gcr.io/xl-ml-test/model-garden:nightly
            imagePullPolicy: Always
            name: train
            resources:
              limits:
                cloud-tpus.google.com/preemptible-v2: 8
          restartPolicy: Never
  schedule: 0 10 30 * *
