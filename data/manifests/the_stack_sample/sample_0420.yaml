apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: tf-r1.15.4-mnasnet-func-v3-32
  namespace: automated
spec:
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600
      backoffLimit: 1
      template:
        metadata:
          annotations:
            tf-version.cloud-tpus.google.com: 1.15.4
        spec:
          containers:
          - env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            image: gcr.io/xl-ml-test/health-monitor:stable
            imagePullPolicy: Always
            name: monitor
          - args:
            - python3
            - /tpu/models/official/mnasnet/mnasnet_main.py
            - --tpu=$(KUBE_GOOGLE_CLOUD_TPU_ENDPOINTS)
            - --iterations_per_loop=1000
            - --mode=train
            - --data_dir=$(IMAGENET_DIR)
            - --model_dir=$(MODEL_DIR)
            - --config_file=/tpu/models/official/mnasnet/configs/cloud/v3-32.yaml
            - --train_steps=1000
            env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: MODEL_DIR
              value: $(OUTPUT_BUCKET)/tf-r1.15.4/mnasnet/func/v3-32/$(JOB_NAME)
            envFrom:
            - configMapRef:
                name: gcs-buckets
            image: gcr.io/xl-ml-test/tensorflow-tpu-1x:r1.15.4
            imagePullPolicy: Always
            name: train
            resources:
              limits:
                cloud-tpus.google.com/preemptible-v3: 32
          initContainers:
          - env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: MODEL_DIR
              value: $(OUTPUT_BUCKET)/tf-r1.15.4/mnasnet/func/v3-32/$(JOB_NAME)
            - name: METRIC_CONFIG
              value: "{\n \"metric_collection_config\": {\n  \"default_aggregation_strategies\"\
                : [\n   \"final\"\n  ],\n  \"write_to_bigquery\": true\n },\n \"regression_test_config\"\
                : {\n  \"metric_success_conditions\": {\n   \"total_wall_time\": {\n\
                \    \"comparison\": \"less\",\n    \"success_threshold\": {\n   \
                \  \"stddevs_from_mean\": 5\n    },\n    \"wait_for_n_points_of_history\"\
                : 10\n   }\n  }\n },\n \"test_name\": \"tf-r1.15.4-mnasnet-func-v3-32\"\
                \n}\n"
            envFrom:
            - configMapRef:
                name: gcs-buckets
            image: gcr.io/xl-ml-test/publisher:stable
            imagePullPolicy: Always
            name: publisher
          nodeSelector:
            tpu-available: 'true'
          restartPolicy: Never
  schedule: 0 6 * * *
  successfulJobsHistoryLimit: 1
