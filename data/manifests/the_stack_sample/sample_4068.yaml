apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform
spec:
  revisionHistoryLimit: 1
  replicas: 1
  selector:
    matchLabels:
      app: platform
  template:
    metadata:
      annotations:
        reloader.stakater.com/search: 'true'
        configmap.reloader.stakater.com/reload: platform-cm,modules-cm,platform-secret-configmap
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/agent-pre-populate-only: 'true'
        vault.hashicorp.com/agent-configmap: $(VC_INSTANCE)-platform-secret-configmap
      labels:
        app: platform
    spec:
      containers:
      - name: vc-platform-web
        image: docker.pkg.github.com/virtocommerce/vc-platform/platform:dev-linux-latest
        envFrom:
        - configMapRef:
            name: platform-cm
        command:
        - /bin/bash
        - -c
        args:
        - source /vault/secrets/config_base && source /vault/secrets/config_custom
          && dotnet VirtoCommerce.Platform.Web.dll
        ports:
        - containerPort: 80
        volumeMounts:
        - mountPath: /opt/virtocommerce/platform/wwwroot/cms-content
          name: cms-content-data
        - mountPath: /opt/virtocommerce/platform/modules
          name: modules-data
      volumes:
      - name: cms-content-data
        persistentVolumeClaim:
          claimName: cms-content-volume
      - name: modules-data
        persistentVolumeClaim:
          claimName: modules-volume
  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
    type: RollingUpdate
