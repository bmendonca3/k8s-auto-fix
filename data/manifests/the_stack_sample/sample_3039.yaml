apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: pt-1.6-hf-glue-bert-b-c-conv-v3-8
  namespace: automated
spec:
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 7200
      backoffLimit: 1
      template:
        metadata:
          annotations:
            tf-version.cloud-tpus.google.com: pytorch-1.6
        spec:
          containers:
          - env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            image: gcr.io/xl-ml-test/health-monitor:stable
            imagePullPolicy: Always
            name: monitor
          - args:
            - /bin/bash
            - -c
            - "set -u\nset -e\nset -x\n\ngit clone --recursive -b r1.6 https://github.com/pytorch-tpu/examples.git\n\
              cd examples/deps/transformers && pip install .\ngit log -1\npython examples/xla_spawn.py\
              \ \\\n  --num_cores 8 \\\n  examples/text-classification/run_glue.py\
              \ \\\n  --logging_dir=./tensorboard-metrics \\\n  --task_name MNLI \\\
              \n  --data_dir /datasets/glue/MNLI \\\n  --cache_dir ./cache_dir \\\n\
              \  --do_train \\\n  --do_eval \\\n  --num_train_epochs 3 \\\n  --max_seq_length\
              \ 128 \\\n  --learning_rate 3e-5 \\\n  --output_dir MNLI \\\n  --overwrite_output_dir\
              \ \\\n  --logging_steps 100 \\\n  --save_steps 3000 \\\n  --overwrite_cache\
              \ \\\n  --tpu_metrics_debug \\\n --model_name_or_path bert-base-cased\
              \ \\\n--per_gpu_train_batch_size 64 \\\n--per_gpu_eval_batch_size 64\n\
              gsutil -m cp -r ./tensorboard-metrics/* $(MODEL_DIR)\n"
            env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: MODEL_DIR
              value: $(OUTPUT_BUCKET)/pt-1.6/hf-glue-bert-b-c/conv/v3-8/$(JOB_NAME)
            - name: XLA_USE_BF16
              value: '0'
            envFrom:
            - configMapRef:
                name: gcs-buckets
            image: gcr.io/xl-ml-test/pytorch-xla:r1.6
            imagePullPolicy: Always
            name: train
            resources:
              limits:
                cloud-tpus.google.com/v3: 8
              requests:
                cpu: '12.0'
                memory: 80Gi
            volumeMounts:
            - mountPath: /dev/shm
              name: dshm
              readOnly: false
            - mountPath: /datasets
              name: pytorch-datasets-claim
              readOnly: true
          initContainers:
          - env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: MODEL_DIR
              value: $(OUTPUT_BUCKET)/pt-1.6/hf-glue-bert-b-c/conv/v3-8/$(JOB_NAME)
            - name: METRIC_CONFIG
              value: "{\n \"metric_collection_config\": {\n  \"default_aggregation_strategies\"\
                : [\n   \"final\"\n  ],\n  \"tags_to_ignore\": [\n   \"LearningRate\"\
                \n  ],\n  \"write_to_bigquery\": true\n },\n \"regression_test_config\"\
                : {\n  \"alert_for_failed_jobs\": false,\n  \"metric_subset_to_alert\"\
                : [\n   \"ExecuteTime__Percentile_99_sec_final\",\n   \"total_wall_time\"\
                ,\n   \"Accuracy/test_final\",\n   \"aten_ops_sum_final\"\n  ],\n\
                \  \"metric_success_conditions\": {\n   \"ExecuteTime__Percentile_99_sec_final\"\
                : {\n    \"comparison\": \"less\",\n    \"success_threshold\": {\n\
                \     \"stddevs_from_mean\": 5\n    },\n    \"wait_for_n_points_of_history\"\
                : 10\n   },\n   \"aten_ops_sum_final\": {\n    \"comparison\": \"\
                less_or_equal\",\n    \"success_threshold\": {\n     \"stddevs_from_mean\"\
                : 0\n    }\n   },\n   \"eval_mnli-mm/acc\": {\n    \"comparison\"\
                : \"greater\",\n    \"success_threshold\": {\n     \"fixed_value\"\
                : 0.80000000000000004\n    }\n   },\n   \"eval_mnli/acc\": {\n   \
                \ \"comparison\": \"greater\",\n    \"success_threshold\": {\n   \
                \  \"fixed_value\": 0.80000000000000004\n    }\n   },\n   \"total_wall_time\"\
                : {\n    \"comparison\": \"less\",\n    \"success_threshold\": {\n\
                \     \"stddevs_from_mean\": 5\n    },\n    \"wait_for_n_points_of_history\"\
                : 10\n   }\n  }\n },\n \"test_name\": \"pt-1.6-hf-glue-bert-b-c-conv-v3-8\"\
                \n}\n"
            envFrom:
            - configMapRef:
                name: gcs-buckets
            image: gcr.io/xl-ml-test/publisher:stable
            imagePullPolicy: Always
            name: publisher
          nodeSelector:
            tpu-available: 'true'
          restartPolicy: Never
          volumes:
          - emptyDir:
              medium: Memory
            name: dshm
          - name: pytorch-datasets-claim
            persistentVolumeClaim:
              claimName: pytorch-datasets-claim
  schedule: 30 2 * * 2,4
  successfulJobsHistoryLimit: 1
