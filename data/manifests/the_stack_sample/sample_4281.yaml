apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-ca
  namespace: openshift-image-registry
spec:
  selector:
    matchLabels:
      name: node-ca
  template:
    metadata:
      labels:
        name: node-ca
    spec:
      nodeSelector:
        kubernetes.io/os: linux
      priorityClassName: system-cluster-critical
      tolerations:
      - operator: Exists
      hostNetwork: true
      serviceAccountName: node-ca
      containers:
      - name: node-ca
        securityContext:
          privileged: true
          runAsUser: 1001
          runAsGroup: 0
        image: docker.io/openshift/origin-cluster-image-registry-operator:latest
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
        command:
        - /bin/sh
        - -c
        - "trap 'jobs -p | xargs -r kill; echo shutting down node-ca; exit 0' TERM\n\
          while [ true ];\ndo\n  for f in $(ls /tmp/serviceca); do\n      echo $f\n\
          \      ca_file_path=\"/tmp/serviceca/${f}\"\n      f=$(echo $f | sed  -r\
          \ 's/(.*)\\.\\./\\1:/')\n      reg_dir_path=\"/etc/docker/certs.d/${f}\"\
          \n      if [ -e \"${reg_dir_path}\" ]; then\n          cp -u $ca_file_path\
          \ $reg_dir_path/ca.crt\n      else\n          mkdir $reg_dir_path\n    \
          \      cp $ca_file_path $reg_dir_path/ca.crt\n      fi\n  done\n  for d\
          \ in $(ls /etc/docker/certs.d); do\n      echo $d\n      dp=$(echo $d |\
          \ sed  -r 's/(.*):/\\1\\.\\./')\n      reg_conf_path=\"/tmp/serviceca/${dp}\"\
          \n      if [ ! -e \"${reg_conf_path}\" ]; then\n          rm -rf /etc/docker/certs.d/$d\n\
          \      fi\n  done\n  sleep 60 & wait ${!}\ndone\n"
        volumeMounts:
        - name: serviceca
          mountPath: /tmp/serviceca
        - name: host
          mountPath: /etc/docker/certs.d
      volumes:
      - name: host
        hostPath:
          path: /etc/docker/certs.d
      - name: serviceca
        configMap:
          name: image-registry-certificates
