apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: secret-reflector
  namespace: networking
spec:
  schedule: 0 */12 * * *
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: sa-secret-reflector
          containers:
          - name: secret-reflector
            image: ghcr.io/k8s-at-home/kubectl:v1.23.1
            env:
            - name: SECRETS
              value: ${SECRET_DOMAIN/./-}-tls
            command:
            - /bin/sh
            - -ec
            - "set -o nounset\nset -o errexit\n# space delimited secrets to copy\n\
              secrets=\"${SECRETS}\"\n# source namespace to reflect secret from\n\
              namespace_source=\"networking\"\n# space delimited namespace where to\
              \ reflect the secrets to\nnamespace_destination=\"home media\"\nfor\
              \ secret in ${secrets}; do\n    secret_source_content=\"$(kubectl get\
              \ secret \"${secret}\" -n \"${namespace_source}\" -o json | jq 'del(.metadata.managedFields,\
              \ .metadata.creationTimestamp, .metadata.resourceVersion, .metadata.uid)')\"\
              \n    secret_source_checksum=\"$(echo \"${secret_source_content}\" |\
              \ jq 'del(.metadata.namespace)' | md5sum | awk '{ print $1 }')\"\n \
              \   for namespace in ${namespace_destination}; do\n        if kubectl\
              \ get secret \"${secret}\" -n \"${namespace}\" >/dev/null 2>&1; then\n\
              \            secret_dest_content=\"$(kubectl get secret \"${secret}\"\
              \ -n \"${namespace}\" -o json | jq 'del(.metadata.managedFields, .metadata.creationTimestamp,\
              \ .metadata.resourceVersion, .metadata.uid)')\"\n            secret_dest_checksum=\"\
              $(echo \"${secret_dest_content}\" | jq 'del(.metadata.namespace)' |\
              \ md5sum | awk '{ print $1 }')\"\n            if [ \"${secret_source_checksum}\"\
              \ != \"${secret_dest_checksum}\" ]; then\n                echo \"${secret_source_content}\"\
              \ | \\\n                    jq -r --arg namespace \"$namespace\" '.metadata.namespace\
              \ = $namespace' | \\\n                    kubectl replace -n \"${namespace}\"\
              \ -f -\n            fi\n        else\n            echo \"${secret_source_content}\"\
              \ | \\\n                jq -r --arg namespace \"$namespace\" '.metadata.namespace\
              \ = $namespace' | \\\n                kubectl apply -n \"${namespace}\"\
              \ -f -\n        fi\n    done\ndone\n"
          restartPolicy: OnFailure
