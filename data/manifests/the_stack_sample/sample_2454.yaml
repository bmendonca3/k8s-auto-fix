apiVersion: v1
kind: Pod
metadata:
  name: fluentd-cloud-logging
  namespace: kube-system
  labels:
    k8s-app: fluentd-logging
  annotations:
    scheduler.alpha.kubernetes.io/critical-pod: ''
spec:
  dnsPolicy: Default
  containers:
  - name: fluentd-cloud-logging
    image: gcr.io/google_containers/fluentd-gcp:1.38
    command:
    - /bin/sh
    - -c
    - /run.sh $FLUENTD_ARGS 2>&1 >>/var/log/fluentd.log
    env:
    - name: FLUENTD_ARGS
      value: --no-supervisor
    resources:
      limits:
        memory: 200Mi
      requests:
        cpu: 100m
        memory: 200Mi
    volumeMounts:
    - name: varlog
      mountPath: /var/log
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: libsystemddir
      mountPath: /host/lib
      readOnly: true
    livenessProbe:
      initialDelaySeconds: 600
      periodSeconds: 60
      exec:
        command:
        - /bin/sh
        - -c
        - "LIVENESS_THRESHOLD_SECONDS=${LIVENESS_THRESHOLD_SECONDS:-300}; STUCK_THRESHOLD_SECONDS=${LIVENESS_THRESHOLD_SECONDS:-900};\
          \ if [ ! -e /var/log/fluentd-buffers ]; then\n  exit 1;\nfi; LAST_MODIFIED_DATE=`stat\
          \ /var/log/fluentd-buffers | grep Modify | sed -r \"s/Modify: (.*)/\\1/\"\
          `; LAST_MODIFIED_TIMESTAMP=`date -d \"$LAST_MODIFIED_DATE\" +%s`; if [ `date\
          \ +%s` -gt `expr $LAST_MODIFIED_TIMESTAMP + $STUCK_THRESHOLD_SECONDS` ];\
          \ then\n  rm -rf /var/log/fluentd-buffers;\n  exit 1;\nfi; if [ `date +%s`\
          \ -gt `expr $LAST_MODIFIED_TIMESTAMP + $LIVENESS_THRESHOLD_SECONDS` ]; then\n\
          \  exit 1;\nfi;\n"
  terminationGracePeriodSeconds: 30
  volumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers
  - name: libsystemddir
    hostPath:
      path: /usr/lib64
